<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExceptionContext.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hoot-runtime</a> &gt; <a href="index.source.html" class="el_package">Hoot.Runtime.Exceptions</a> &gt; <span class="el_source">ExceptionContext.java</span></div><h1>ExceptionContext.java</h1><pre class="source lang-java linenums">package Hoot.Runtime.Exceptions;

import java.util.*;
import Hoot.Runtime.Blocks.*;
import Hoot.Runtime.Faces.Valued;
import Hoot.Runtime.Values.Cacheable;
import Hoot.Runtime.Values.CachedStack;
import static Hoot.Runtime.Functions.Utils.*;

/**
 * Provides a context for evaluating blocks and handling exceptions.
 *
 * @author nik &lt;nikboyd@sonic.net&gt;
 * @see &quot;Copyright 2010,2021 Nikolas S Boyd.&quot;
 * @see &quot;Permission is granted to copy this work provided this copyright statement is retained in all copies.&quot;
 */
<span class="fc" id="L17">public class ExceptionContext implements Valued, Cacheable&lt;ExceptionContext&gt; {</span>

    // an empty marker context for retry
<span class="fc" id="L20">    protected static final ExceptionContext RetryToken = new ExceptionContext();</span>
<span class="fc" id="L21">    protected static final ExceptionContext Unhandled = new ExceptionContext();</span>
<span class="nc bnc" id="L22" title="All 2 branches missed.">    protected boolean isUnhandled() { return Unhandled == this; }</span>

<span class="fc" id="L24">    private static final CachedStack&lt;ExceptionContext&gt; ContextStack = new CachedStack&lt;&gt;();</span>
<span class="fc" id="L25">    static { ContextStack.defaultIfEmpty(Unhandled); }</span>

<span class="nc" id="L27">    protected static CachedStack&lt;ExceptionContext&gt; contextStack() { return ContextStack; }</span>
<span class="nc" id="L28">    @Override public CachedStack&lt;ExceptionContext&gt; itemStack() { return contextStack(); }</span>

<span class="nc" id="L30">    protected static Stack&lt;ExceptionContext&gt; contexts() { return contextStack().cachedStack(); }</span>
<span class="nc" id="L31">    public static ExceptionContext environment() { return contextStack().top(); }</span>
<span class="nc" id="L32">    protected static ExceptionContext pop() { return contextStack().pop(); }</span>
<span class="nc" id="L33">    protected void push() { contextStack().push(this); }</span>

<span class="fc" id="L35">    protected int stackIndex = 0;</span>
<span class="nc" id="L36">    @Override public int stackIndex() { return this.stackIndex; }</span>
<span class="nc" id="L37">    @Override public void stackIndex(int value) { this.stackIndex = value; }</span>

<span class="nc" id="L39">    public static Enclosure findHandler(HandledException.Metatype type) { return findHandler(type.primitiveClass()); }</span>
<span class="nc" id="L40">    public static Enclosure findHandler(Class type) { return environment().findHandlerFor(type); }</span>

<span class="nc" id="L42">    public static Enclosure findPriorHandler(HandledException.Metatype type) { return findPriorHandler(type.primitiveClass()); }</span>
<span class="nc" id="L43">    public static Enclosure findPriorHandler(Class type) { return environment().priorContext().findHandlerFor(type); }</span>

    public boolean hasPriorHandler(HandledException ex) {
<span class="nc" id="L46">        Enclosure pass = priorContext().findHandlerFor(ex.valueType()); return hasAny(pass); }</span>

    public void passFrom(HandledException ex) {
<span class="nc" id="L49">        ExceptionContext prior = priorContext();</span>
<span class="nc" id="L50">        Enclosure pass = prior.findHandlerFor(ex.valueType());</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        if (hasAny(pass)) pass.handleSignaled(ex); }</span>

<span class="nc" id="L53">    protected ExceptionContext withIndex(int index) { this.stackIndex = index; return this; }</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">    public ExceptionContext priorContext() { return isBottom()? Unhandled : contexts().get(stackIndex - 1); }</span>
<span class="nc" id="L55">    public Enclosure findHandler(HandledException ex) { return findHandlerFor(ex.valueType()); }</span>
    public Enclosure findHandlerFor(Class type) {
<span class="nc bnc" id="L57" title="All 2 branches missed.">        if (isUnhandled()) return null; // check empty handlers?</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (handles(type)) return handlerFor(type);</span>
<span class="nc" id="L59">        return priorContext().findHandlerFor(type);</span>
    }

    protected MonadicValuable continuation;
<span class="nc" id="L63">    public MonadicValuable continuation() { return this.continuation; }</span>
<span class="nc" id="L64">    public ExceptionContext continuation(MonadicValuable block) { this.continuation = block; return this; }</span>
<span class="nc" id="L65">    public ExceptionContext $return(Valued value) { continuation().value(value); return this; }</span>

    protected MonadicValuable responseBlock;
<span class="nc" id="L68">    public MonadicValuable responseBlock() { return this.responseBlock; }</span>
<span class="nc" id="L69">    public ExceptionContext responseBlock(MonadicValuable block) { this.responseBlock = block; return this; }</span>

    protected NiladicValuable retryBlock;
<span class="nc" id="L72">    public NiladicValuable retryBlock() { return this.retryBlock; }</span>
<span class="nc" id="L73">    public ExceptionContext retryBlock(NiladicValuable block) { this.retryBlock = block; return this; }</span>
<span class="nc" id="L74">    public ExceptionContext retry(NiladicValuable block) { retryBlock(block); return this; }</span>
<span class="nc" id="L75">    public ExceptionContext retry() { $return(RetryToken); return this; }</span>

    protected MonadicValuable resultContinuation;
<span class="nc" id="L78">    public MonadicValuable resultContinuation() { return this.resultContinuation; }</span>
<span class="nc" id="L79">    public ExceptionContext resultContinuation(MonadicValuable block) { this.resultContinuation = block; return this; }</span>
<span class="nc" id="L80">    public ExceptionContext resume(Valued value) { resultContinuation().value(value); return this; }</span>

    protected Valued evaluateResponse_for(Arguable block, HandledException ex) {
<span class="nc bnc" id="L83" title="All 2 branches missed.">        return (0 == block.argumentCount().intValue()) ?</span>
<span class="nc" id="L84">            ((NiladicValuable)block).value() : (evaluateResponse_with((MonadicValuable)block, ex)); }</span>

    protected Valued evaluateResponse_with(MonadicValuable block, HandledException ex) {
<span class="nc" id="L87">        resultContinuation(Enclosure.withBlock((f) -&gt; { return f.getValue(0).value(); }));</span>
<span class="nc" id="L88">        return block.value(ex); }</span>

    protected Valued evaluateProtected(NiladicValuable block) {
<span class="nc" id="L91">        continuation(Enclosure.withBlock((f) -&gt; { return f.getValue(0).value(); }));</span>
<span class="nc" id="L92">        return block.value(); }</span>

    public Valued handle(HandledException ex) {
<span class="nc" id="L95">        Valued result = null;</span>
<span class="nc" id="L96">        Stack&lt;ExceptionContext&gt; stack = contexts();</span>
//        var environ = pop();
        try {
<span class="nc" id="L99">            push();</span>
<span class="nc" id="L100">            result = this.evaluateResponse_for(responseBlock(), ex);</span>
        }
        finally {
<span class="nc" id="L103">            pop();</span>
//            push(environ);
        }
<span class="nc" id="L106">        return result;</span>
    }

    public Valued activateDuring(NiladicValuable block) {
<span class="nc" id="L110">        Valued result = null;</span>
<span class="nc" id="L111">        Stack&lt;ExceptionContext&gt; stack = contexts();</span>
//        var environ = pop();
        try {
<span class="nc" id="L114">            push();</span>
<span class="nc" id="L115">            retryBlock(block);</span>
            do {
<span class="nc" id="L117">                result = this.evaluateProtected(retryBlock());</span>
            }
<span class="nc bnc" id="L119" title="All 2 branches missed.">            while (RetryToken == result);</span>
        }
        finally {
<span class="nc" id="L122">            pop();</span>
//            push(environ);
        }
<span class="nc" id="L125">        return result;</span>
    }

    public static Valued during_handle(NiladicValuable aBlock, MonadicValuable handlerBlock) {
<span class="nc" id="L129">        ExceptionContext context = new ExceptionContext().withHandler((Enclosure)handlerBlock);</span>
<span class="nc" id="L130">        return context.activateDuring(aBlock); }</span>

    public static Valued activateHandler(HandledException ex) {
<span class="nc" id="L133">        Enclosure handler = findHandler(ex.valueType());</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        return hasAny(handler)? handler.handleSignaled(ex) : ex.defaultAction(); }</span>

<span class="fc" id="L136">    private final HashMap&lt;Class,Enclosure&gt; handlers = emptyMap(Class.class, Enclosure.class);</span>
<span class="nc" id="L137">    private HashMap&lt;Class,Enclosure&gt; handlerMap() { return this.handlers; }</span>
<span class="nc" id="L138">    private Collection&lt;Enclosure&gt; handlers() { return handlerMap().values(); }</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">    protected boolean hasHandlers() { return !handlerMap().isEmpty(); }</span>
<span class="nc" id="L140">    protected void clearHandlers() { handlerMap().clear(); }</span>
    protected ExceptionContext withHandler(Enclosure handlerBlock) {
<span class="nc" id="L142">        responseBlock(handlerBlock); handlerBlock.context(this);</span>
<span class="nc" id="L143">        handlerBlock.coveredExceptions().forEach((h) -&gt; handlerMap().put(h, handlerBlock));</span>
<span class="nc" id="L144">        return this; }</span>

<span class="nc" id="L146">    public Enclosure handlerFor(HandledException ex) { return nullOr((x) -&gt; handlerFor(x.valueType()), ex); }</span>
<span class="nc" id="L147">    public Enclosure handlerFor(Class type) { return findFirst(handlers(), (h) -&gt; h.handles(type)); }</span>
<span class="nc" id="L148">    public boolean handles(Class type) {return matchAny(handlers(), (h) -&gt; h.handles(type)); }</span>

} // ExceptionContext
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>