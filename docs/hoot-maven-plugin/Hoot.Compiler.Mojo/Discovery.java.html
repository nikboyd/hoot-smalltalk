<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Discovery.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hoot-maven-plugin</a> &gt; <a href="index.source.html" class="el_package">Hoot.Compiler.Mojo</a> &gt; <span class="el_source">Discovery.java</span></div><h1>Discovery.java</h1><pre class="source lang-java linenums">package Hoot.Compiler.Mojo;


import java.io.*;
import java.util.*;
import org.eclipse.aether.*;
import org.eclipse.aether.artifact.*;
import org.eclipse.aether.repository.*;
import org.eclipse.aether.resolution.*;
import org.eclipse.aether.impl.DefaultServiceLocator;
import org.eclipse.aether.spi.connector.transport.TransporterFactory;
import org.eclipse.aether.transport.file.FileTransporterFactory;
import org.eclipse.aether.transport.http.HttpTransporterFactory;
import org.apache.maven.repository.internal.*;

import Hoot.Runtime.Faces.Logging;
import static Hoot.Runtime.Functions.Utils.*;
import static Hoot.Runtime.Functions.Exceptional.*;

/**
 * Discovers locally available library JARs cached by Maven.
 * @author nik &lt;nikboyd@sonic.net&gt;
 * @see &quot;Copyright 2020 Nikolas S Boyd.&quot;
 * @see &quot;Permission is granted to copy this work provided this copyright statement is retained in all copies.&quot;
 */
<span class="fc" id="L26">public class Discovery implements Logging {</span>

<span class="fc" id="L28">    List&lt;RemoteRepository&gt; remotes = emptyList(RemoteRepository.class);</span>
<span class="fc" id="L29">    List&lt;RemoteRepository&gt; remotes() { return this.remotes; }</span>
<span class="fc" id="L30">    Artifact buildArtifact(String partName) { return new DefaultArtifact(partName); }</span>
<span class="fc" id="L31">    ArtifactRequest buildRequest(Artifact art) { return new ArtifactRequest(art, remotes(), null); }</span>
<span class="fc" id="L32">    ArtifactRequest requestArtifact(String partName) { return buildRequest(buildArtifact(partName)); }</span>


    static final String UserHome = &quot;user.home&quot;;
<span class="fc" id="L36">    public static String userHome() { return System.getProperty(UserHome); }</span>

    static final String MavenRepo = &quot;maven.repo.local&quot;;
    static final String LocalFolder = &quot;.m2/repository&quot;;
    public static File localMavenFolder() {
<span class="fc" id="L41">        String localFolder = System.getProperty(MavenRepo, Empty);</span>
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">        return localFolder.isEmpty() ? new File(userHome(), LocalFolder) :  new File(localFolder); }</span>

<span class="fc" id="L44">    static RepositorySystem Repository = buildRepository();</span>
<span class="fc" id="L45">    static RepositorySystem repository() { return Repository; }</span>

    static RepositorySystem buildRepository() {
<span class="fc" id="L48">        DefaultServiceLocator locator = MavenRepositorySystemUtils.newServiceLocator();</span>
<span class="fc" id="L49">        locator.addService(TransporterFactory.class, FileTransporterFactory.class);</span>
<span class="fc" id="L50">        locator.addService(TransporterFactory.class, HttpTransporterFactory.class);</span>
<span class="fc" id="L51">        return locator.getService(RepositorySystem.class); }</span>

<span class="fc" id="L53">    DefaultRepositorySystemSession session = buildSession();</span>
<span class="fc" id="L54">    DefaultRepositorySystemSession session() { return this.session; }</span>
<span class="fc" id="L55">    static DefaultRepositorySystemSession buildSession() { return MavenRepositorySystemUtils.newSession(); }</span>

<span class="fc" id="L57">    static final Discovery CachedDiscovery = new Discovery();</span>
<span class="fc" id="L58">    public static Discovery cachedDiscovery() { return CachedDiscovery; }</span>

    public static final String HootSmalltalk = &quot;hoot-smalltalk&quot;;
<span class="fc" id="L61">    static { cachedDiscovery().cacheLocalRepository(); }</span>

    void cacheLocalRepository() {
<span class="fc" id="L64">        File localFolder = localMavenFolder();</span>
<span class="fc" id="L65">        reportWhetherFound(LocalFolder, localFolder);</span>
<span class="fc" id="L66">        LocalRepository result = new LocalRepository(localFolder);</span>
<span class="fc" id="L67">        session().setLocalRepositoryManager(repository().newLocalRepositoryManager(session(), result));</span>
<span class="fc" id="L68">    }</span>

    public static ArtifactResult lookup(String partName) {
<span class="fc" id="L71">        return cachedDiscovery().lookupArtifact(cachedDiscovery().requestArtifact(partName)); }</span>

    ArtifactResult lookupArtifact(ArtifactRequest r) {
<span class="fc" id="L74">        return nullOrTryQuietly(() -&gt; { return repository().resolveArtifact(session(), r); }); }</span>

    static final String FoundLocally = &quot;found '%s' locally: %s&quot;;
    static final String NotFound = &quot;not &quot; + FoundLocally;
<span class="pc bpc" id="L78" title="2 of 4 branches missed.">    public boolean found(File localFolder) { return hasSome(localFolder) &amp;&amp; localFolder.exists(); }</span>
    void reportWhetherFound(String folderName, File localFolder) {
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if (found(localFolder)) // expected</span>
<span class="fc" id="L81">            whisper(format(FoundLocally, folderName, localFolder.getAbsolutePath()));</span>
        else // not found, unexpected!
<span class="nc" id="L83">            warn(format(NotFound, folderName, &quot;???&quot;));</span>
<span class="fc" id="L84">    }</span>

} // Discovery
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>