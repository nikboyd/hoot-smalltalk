<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Servant.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hoot-maven-plugin</a> &gt; <a href="index.source.html" class="el_package">Hoot.Compiler.Mojo</a> &gt; <span class="el_source">Servant.java</span></div><h1>Servant.java</h1><pre class="source lang-java linenums">package Hoot.Compiler.Mojo;

import java.io.*;
import java.util.Properties;
import org.apache.commons.lang3.SystemUtils;
import org.eclipse.aether.artifact.Artifact;
import static Hoot.Runtime.Functions.Exceptional.*;
import Hoot.Runtime.Faces.Logging;

/**
 * Compiles Hoot code in a separate process.
 *
 * @author nik &lt;nikboyd@sonic.net&gt;
 * @see &quot;Copyright 2010,2021 Nikolas S Boyd.&quot;
 * @see &quot;Permission is granted to copy this work provided this copyright statement is retained in all copies.&quot;
 */
<span class="fc" id="L17">public class Servant implements Logging {</span>

<span class="fc" id="L19">    private Process remoteProcess = null;</span>
    public void runCompiler(String... args) {
<span class="fc" id="L21">        runLoudly(() -&gt; {</span>
<span class="fc" id="L22">            remoteProcess = buildProcess(args).start();</span>
<span class="fc" id="L23">            new Thread(() -&gt; pipeShellOutput()).start();</span>
<span class="fc" id="L24">            remoteProcess.waitFor();</span>
<span class="fc" id="L25">        });</span>
<span class="fc" id="L26">    }</span>

<span class="fc" id="L28">    InputStream processStream() { return remoteProcess.getInputStream(); }</span>
<span class="fc" id="L29">    BufferedReader processReader() { return new BufferedReader(new InputStreamReader(processStream())); }</span>
    void pipeShellOutput() {
<span class="fc" id="L31">        String line; BufferedReader reader = processReader();</span>
<span class="fc bfc" id="L32" title="All 2 branches covered.">        try { while((line = reader.readLine()) != null) report(line); }</span>
<span class="pc" id="L33">        catch (IOException x) { error(x); }</span>
<span class="fc" id="L34">    }</span>

<span class="fc" id="L36">    Properties p = new Properties();</span>
    static final String Version = &quot;version&quot;; // loaded value name
    static final String MojoVersion = &quot;/version.properties&quot;;
<span class="fc" id="L39">    String version() { runLoudly(() -&gt; loadVersion(p)); return p.getProperty(Version); }</span>
<span class="fc" id="L40">    void loadVersion(Properties p) throws IOException { try (InputStream in = versionStream()) { p.load(in); } }</span>
<span class="fc" id="L41">    InputStream versionStream() throws IOException { return getClass().getResourceAsStream(MojoVersion); }</span>

    static final String CompilerSpec = &quot;hoot-smalltalk:hoot-compiler-boot:&quot;;
<span class="fc" id="L44">    Artifact locateArtifact() { return Discovery.lookup(CompilerSpec + version()).getArtifact(); }</span>
<span class="fc" id="L45">    String locateCompiler() { return locateArtifact().getFile().getAbsolutePath(); }</span>
    
    static final String Quote = &quot;\&quot;&quot;;
    static final String WinShell = &quot;cmd.exe&quot;;
    static final String WinCommand = &quot;'%%JAVA_HOME%%\\bin\\java' -jar %s&quot;;
    String buildWinCommand(String... args) { 
<span class="nc" id="L51">        String result = format(WinCommand, locateCompiler()).replace(&quot;'&quot;, Quote);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">        for (String s : args) { result += &quot; &quot; + s; }</span>
<span class="nc" id="L53">        report(&quot;running &quot;+result);</span>
<span class="nc" id="L54">        return result; }</span>

    static final String Shell = &quot;/bin/sh&quot;;
    static final String JavaCommand = &quot;java -jar %s&quot;;
    String buildJavaCommand(String... args) { 
<span class="fc" id="L59">        String result = format(JavaCommand, locateCompiler());</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">        for (String s : args) { result += &quot; &quot; + s; }</span>
<span class="fc" id="L61">        report(&quot;running &quot;+result);</span>
<span class="fc" id="L62">        return result; }</span>

    ProcessBuilder buildProcess(String... args) {
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">        return SystemUtils.IS_OS_WINDOWS ? </span>
<span class="nc" id="L66">            new ProcessBuilder(WinShell, &quot;/c&quot;, buildWinCommand(args)) :</span>
<span class="fc" id="L67">            new ProcessBuilder(Shell, &quot;-c&quot;, buildJavaCommand(args)); }</span>

} // Servant
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>