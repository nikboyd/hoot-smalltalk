<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HootMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hoot-maven-plugin</a> &gt; <a href="index.source.html" class="el_package">Hoot.Compiler.Mojo</a> &gt; <span class="el_source">HootMojo.java</span></div><h1>HootMojo.java</h1><pre class="source lang-java linenums">package Hoot.Compiler.Mojo;

import java.io.*;
import java.util.*;
import static Hoot.Compiler.HootMain.*;

import org.apache.maven.plugin.*;
import org.apache.maven.plugins.annotations.*;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.project.MavenProject;

/**
 * A mojo for the Hoot compiler.
 * @author nik &lt;nikboyd@sonic.net&gt;
 * @see &quot;Copyright 2020 Nikolas S Boyd.&quot;
 * @see &quot;Permission is granted to copy this work provided this copyright statement is retained in all copies.&quot;
 */
@Mojo(name = HootMojo.Generate, defaultPhase = LifecyclePhase.GENERATE_SOURCES)
<span class="fc" id="L19">public class HootMojo extends AbstractMojo {</span>

    public static final String Generate = &quot;generate&quot;;
<span class="fc" id="L22">    @Override public void execute() throws MojoExecutionException, MojoFailureException { runChoice(); }</span>
<span class="pc bpc" id="L23" title="1 of 2 branches missed.">    void runChoice() { if (wantsTest()) reportOptions(); else runCompile(); }</span>
<span class="fc" id="L24">    boolean wantsTest() { return True.equals(getArg(Test)); }</span>
    static final String True = &quot;true&quot;;

    /**
     * Locates a Maven project that contains some Hoot code to be compiled.
     */
    @Parameter(defaultValue = &quot;${project}&quot;) MavenProject project;
<span class="nc" id="L31">    File getProjectFolder() { return project.getBasedir(); }</span>
<span class="nc" id="L32">    String getProjectFolderTail() { return getProjectFolder().getName(); }</span>

<span class="fc" id="L34">    File findFolder(String folderPath) { return new File(getTargetFolder(), folderPath); }</span>
<span class="fc" id="L35">    File getTargetFolder() { return new File(System.getProperty(BasePath), getArg(Folder)); }</span>
<span class="pc bpc" id="L36" title="1 of 2 branches missed.">    void addTargetFolder() { if (!hasArg(Source)) project.addCompileSourceRoot(findFolder(TargetPath).getPath()); }</span>

    /**
     * Contains (optional) arguments sent to the Hoot compiler main() entry point.
     */
<span class="fc" id="L41">    @Parameter(name = &quot;main-args&quot;) Map&lt;String,String&gt; mainArgs = new HashMap();</span>
<span class="fc" id="L42">    void addArgs() { mainArgs.forEach((k,v) -&gt; addOption(k,v)); }</span>

    static final String TargetReport = &quot; located folder = ../%s&quot;;
    void addDefaultArgs() {
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">        if (!hasArg(Folder)) {</span>
<span class="nc" id="L47">            mainArgs.put(Folder, getProjectFolderTail());</span>
<span class="nc" id="L48">            report(String.format(TargetReport, getArg(Folder)));</span>
        }
<span class="fc" id="L50">    }</span>

<span class="fc" id="L52">    boolean hasArg(String argName) { return mainArgs.containsKey(argName); }</span>
<span class="fc" id="L53">    String getArg(String argName) { return mainArgs.getOrDefault(argName, getDefault(argName)); }</span>
<span class="fc" id="L54">    String getDefault(String argName) { return OptionalBools.getOrDefault(argName, &quot;&quot;); }</span>

    /**
     * Contains a list of (optional) package names sent to the Hoot compiler.
     */
<span class="fc" id="L59">    @Parameter() List&lt;String&gt; packages = new ArrayList();</span>
<span class="fc" id="L60">    void addPackages() { commandArgs.add(shortened(Packages)); packages.forEach(p -&gt; commandArgs.add(p)); }</span>

<span class="fc" id="L62">    static final String[] NoArgs = { };</span>
    String[] buildCommandArgs() {
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        if (packages.isEmpty()) packages.add(WildCard);</span>
<span class="fc" id="L65">        addArgs(); addPackages(); return commandArgs.toArray(NoArgs); }</span>

    static final String Dashed = &quot;--&quot;;
    static final String ShowHelp = Dashed + Help;
    static final String Testing = &quot;testing Hoot compiler ...&quot;;
<span class="pc bpc" id="L70" title="2 of 4 branches missed.">    void report(String... s) { if (s != null &amp;&amp; s.length &gt; 0) System.out.println(s[0]); else System.out.println(); }</span>
<span class="fc" id="L71">    void reportOptions() { report(Testing); runCompile(); report(Empty); main(ShowHelp); }</span>
    void runCompile() {
<span class="fc" id="L73">        addDefaultArgs();</span>
<span class="fc" id="L74">        addTargetFolder();</span>
<span class="fc" id="L75">        main(buildCommandArgs());</span>

        // check for tests
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        if (findFolder(SourceTest).exists()) {</span>
<span class="nc" id="L79">            report();</span>
<span class="nc" id="L80">            main(buildTestCompile());</span>
        }
<span class="fc" id="L82">    }</span>

<span class="fc" id="L84">    List&lt;String&gt; commandArgs = new ArrayList();</span>
    void addOption(String k, String v) {
<span class="fc bfc" id="L86" title="All 2 branches covered.">        if (OptionalBools.containsKey(k)) {</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">            if (True.equals(v)) { // map 'test' to 'only-test'</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">                String key = Test.equals(k) ? TestOnly : k;</span>
<span class="fc" id="L89">                commandArgs.add(Dashed + key);</span>
<span class="fc" id="L90">            }</span>
        }
        else {
<span class="fc" id="L93">            commandArgs.add(Dashed + k);</span>
<span class="fc" id="L94">            commandArgs.add(v);</span>
        }
<span class="fc" id="L96">    }</span>

    String[] buildTestCompile() {
<span class="nc" id="L99">        String testSource = findFolder(SourceTest).getPath();</span>
<span class="nc" id="L100">        String testTarget = findFolder(TargetTest).getPath();</span>
<span class="nc" id="L101">        project.addTestCompileSourceRoot(testTarget);</span>

<span class="nc" id="L103">        packages.clear();</span>
<span class="nc" id="L104">        commandArgs.clear();</span>
<span class="nc" id="L105">        mainArgs.remove(Source);</span>
<span class="nc" id="L106">        mainArgs.put(Folder, testTarget);</span>
<span class="nc" id="L107">        mainArgs.put(TestSource, testSource);</span>
<span class="nc" id="L108">        return buildCommandArgs();</span>
    }

} // HootMojo
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>