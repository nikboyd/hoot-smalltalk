<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HootMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hoot-maven-plugin</a> &gt; <a href="index.source.html" class="el_package">Hoot.Compiler.Mojo</a> &gt; <span class="el_source">HootMojo.java</span></div><h1>HootMojo.java</h1><pre class="source lang-java linenums">package Hoot.Compiler.Mojo;

import java.io.*;
import java.util.*;
import Hoot.Runtime.Faces.Logging;
import static Hoot.Runtime.Functions.Utils.*;

import org.apache.maven.plugin.*;
import org.apache.maven.plugins.annotations.*;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.project.MavenProject;

/**
 * A mojo for the Hoot compiler.
 * @author nik &lt;nikboyd@sonic.net&gt;
 * @see &quot;Copyright 2020 Nikolas S Boyd.&quot;
 * @see &quot;Permission is granted to copy this work provided this copyright statement is retained in all copies.&quot;
 */
@Mojo(name = HootMojo.Generate, defaultPhase = LifecyclePhase.GENERATE_SOURCES)
<span class="fc" id="L20">public class HootMojo extends AbstractMojo implements Logging {</span>

    public static final String Generate = &quot;generate&quot;;
<span class="fc" id="L23">    @Override public void execute() throws MojoExecutionException, MojoFailureException { runChoice(); }</span>
<span class="pc bpc" id="L24" title="1 of 2 branches missed.">    void runChoice() { if (wantsTest()) reportOptions(); else runCompile(); }</span>
<span class="fc" id="L25">    boolean wantsTest() { return True.equals(getArg(Test)); }</span>
    public static final String Test = &quot;test&quot;;
    static final String True = &quot;true&quot;;

    /**
     * Locates a Maven project that contains some Hoot code to be compiled.
     */
    @Parameter(defaultValue = &quot;${project}&quot;) MavenProject project;
<span class="nc" id="L33">    File getProjectFolder() { return project.getBasedir(); }</span>
<span class="nc" id="L34">    String getProjectFolderTail() { return getProjectFolder().getName(); }</span>

<span class="fc" id="L36">    String normalPath(String p) { return Hoot.Runtime.Maps.Package.normalPath(p); }</span>
<span class="fc" id="L37">    File findFolder(String folderPath) { return new File(getTargetFolder(), normalPath(folderPath)); }</span>

    public static final String Folder = &quot;folder&quot;;
    public static final String BasePath = &quot;user.dir&quot;;
<span class="fc" id="L41">    File getTargetFolder() { return new File(System.getProperty(BasePath), normalPath(getArg(Folder))); }</span>

    public static final String Source = &quot;source&quot;;
    public static final String TargetPath = &quot;target/generated-sources/hoot-maven-plugin&quot;;
<span class="pc bpc" id="L45" title="1 of 2 branches missed.">    void addTargetFolder() { if (!hasArg(Source)) project.addCompileSourceRoot(findFolder(TargetPath).getPath()); }</span>

    /**
     * Contains (optional) arguments sent to the Hoot compiler main() entry point.
     */
<span class="fc" id="L50">    @Parameter(name = &quot;main-args&quot;) Map&lt;String,String&gt; mainArgs = new HashMap();</span>
<span class="fc" id="L51">    void addArgs() { mainArgs.forEach((k,v) -&gt; addOption(k,v)); }</span>

    static final String TargetReport = &quot; located folder = ../%s&quot;;
    void addDefaultArgs() {
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        if (!hasArg(Folder)) {</span>
<span class="nc" id="L56">            mainArgs.put(Folder, getProjectFolderTail());</span>
<span class="nc" id="L57">            report(String.format(TargetReport, getArg(Folder)));</span>
        }
<span class="fc" id="L59">    }</span>

<span class="fc" id="L61">    boolean hasArg(String argName) { return mainArgs.containsKey(argName); }</span>
<span class="fc" id="L62">    String getArg(String argName) { return mainArgs.getOrDefault(argName, getDefault(argName)); }</span>
<span class="fc" id="L63">    String getDefault(String argName) { return OptionalBools.getOrDefault(argName, &quot;&quot;); }</span>

    /**
     * Contains a list of (optional) package names sent to the Hoot compiler.
     */
<span class="fc" id="L68">    @Parameter() List&lt;String&gt; packages = new ArrayList();</span>
    public static final String Packages = &quot;packages&quot;;
<span class="pc" id="L70">    void addPackages() { commandArgs.add(shortened(Packages)); packages.forEach(p -&gt; commandArgs.add(p)); }</span>
<span class="fc" id="L71">    public static String shortened(String optionName) { return Dash + shortOption(optionName); }</span>
<span class="fc" id="L72">    static String shortOption(String optionName) { return optionName.substring(0, 1); }</span>

    String[] buildCommandArgs() {
<span class="fc" id="L75">        addArgs(); addPackages();</span>
<span class="fc" id="L76">        return commandArgs(); }</span>

    static final String Dash = &quot;-&quot;;
    static final String Dashed = &quot;--&quot;;
    public static final String Help = &quot;help&quot;;
    static final String ShowHelp = Dashed + Help;
    static final String Testing = &quot;testing Hoot compiler ...&quot;;
<span class="fc" id="L83">    void reportOptions() { report(Testing); runCompile(); report(Empty); runMain(ShowHelp); }</span>

    void runCompile() {
<span class="fc" id="L86">        addDefaultArgs();</span>
<span class="fc" id="L87">        addTargetFolder();</span>
<span class="fc" id="L88">        runMain(buildCommandArgs());</span>

        // check for tests
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        if (findFolder(SourceTest).exists()) {</span>
<span class="nc" id="L92">            report(&quot;&quot;);</span>
<span class="nc" id="L93">            runMain(buildTestCompile());</span>
        }
<span class="fc" id="L95">    }</span>

<span class="fc" id="L97">    static final Servant mainServant = new Servant();</span>
<span class="fc" id="L98">    void runMain(String... s) { mainServant.runCompiler(s); }</span>

<span class="fc" id="L100">    static final String[] NoArgs = { };</span>
<span class="fc" id="L101">    List&lt;String&gt; commandArgs = new ArrayList();</span>
<span class="fc" id="L102">    String[] commandArgs() { return commandArgs.toArray(NoArgs); }</span>

    public static final String TestOnly = &quot;only-test&quot;;
    void addOption(String k, String v) {
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (OptionalBools.containsKey(k)) {</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">            if (True.equals(v)) { // map 'test' to 'only-test'</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">                String key = Test.equals(k) ? TestOnly : k;</span>
<span class="fc" id="L109">                commandArgs.add(Dashed + key);</span>
<span class="fc" id="L110">            }</span>
        }
        else {
<span class="fc" id="L113">            commandArgs.add(Dashed + k);</span>
<span class="fc" id="L114">            commandArgs.add(v);</span>
        }
<span class="fc" id="L116">    }</span>

    public static final String TestSource = &quot;test-source&quot;;
    public static final String SourceTest = &quot;src/test/hoot&quot;;
    public static final String TargetTest = &quot;target/generated-test-sources/hoot-maven-plugin&quot;;
    String[] buildTestCompile() {
<span class="nc" id="L122">        String testSource = findFolder(SourceTest).getPath();</span>
<span class="nc" id="L123">        String testTarget = findFolder(TargetTest).getPath();</span>
<span class="nc" id="L124">        project.addTestCompileSourceRoot(testTarget);</span>

<span class="nc" id="L126">        packages.clear();</span>
<span class="nc" id="L127">        commandArgs.clear();</span>
<span class="nc" id="L128">        mainArgs.remove(Source);</span>
<span class="nc" id="L129">        mainArgs.put(Folder, testTarget);</span>
<span class="nc" id="L130">        mainArgs.put(TestSource, testSource);</span>
<span class="nc" id="L131">        return buildCommandArgs();</span>
    }

<span class="fc" id="L134">    public static final String[] Optionals = { Help, Test };</span>
<span class="fc" id="L135">    public static final Map&lt;String, String&gt; OptionalBools = new HashMap();</span>
    static {
<span class="fc" id="L137">        OptionalBools.put(Help, &quot;false&quot;);</span>
<span class="fc" id="L138">        OptionalBools.put(Test, &quot;false&quot;);</span>
<span class="fc" id="L139">    }</span>

} // HootMojo
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>