<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UnarySequence.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hoot-compiler</a> &gt; <a href="index.source.html" class="el_package">Hoot.Compiler.Expressions</a> &gt; <span class="el_source">UnarySequence.java</span></div><h1>UnarySequence.java</h1><pre class="source lang-java linenums">package Hoot.Compiler.Expressions;

import java.util.*;
import Hoot.Runtime.Names.Keyword;
import Hoot.Runtime.Names.TypeName;
import Hoot.Runtime.Behaviors.Scope;
import Hoot.Runtime.Emissions.Emission;
import static Hoot.Runtime.Values.Exit.*;
import static Hoot.Runtime.Functions.Utils.*;
import static Hoot.Runtime.Names.Keyword.*;
import static Hoot.Runtime.Names.Primitive.*;

import Hoot.Compiler.Scopes.*;
import Hoot.Compiler.Constants.*;

/**
 * An unary sequence.
 *
 * @author nik &lt;nikboyd@sonic.net&gt;
 * @see &quot;Copyright 1999,2021 Nikolas S Boyd.&quot;
 * @see &quot;Permission is granted to copy this work provided this copyright statement is retained in all copies.&quot;
 */
public class UnarySequence extends Message {

<span class="fc" id="L25">    public UnarySequence() { super(Scope.current()); }</span>
<span class="fc" id="L26">    @Override public void clean() { super.clean(); cleanPrimary(); }</span>

<span class="fc" id="L28">    public static UnarySequence yourself() { return with(Primary.with(LiteralName.with(Self))); }</span>
<span class="fc" id="L29">    public static UnarySequence frame() { return with(Primary.with(LiteralName.with(FrameId))); }</span>
    public static UnarySequence exitFrom(Scope scope) {
<span class="fc" id="L31">        return with(Primary.with(LiteralName.with(quoteWith(NativeQuote, scope.description())))); }</span>

<span class="fc" id="L33">    public static UnarySequence with(String selector) { return with(null, selector); }</span>
<span class="fc" id="L34">    public static UnarySequence with(Primary term) { return with(term, emptyList(String.class)); }</span>
    public static UnarySequence with(Primary term, String... selectors) {
<span class="fc" id="L36">        return with(term, wrap(selectors)); }</span>

    public static UnarySequence with(Primary term, List&lt;String&gt; selectors) {
<span class="fc" id="L39">        UnarySequence result = new UnarySequence();</span>
<span class="fc" id="L40">        result.selectors.addAll(selectors);</span>
<span class="fc" id="L41">        return result.withPrimary(term);</span>
    }


<span class="fc" id="L45">    List&lt;String&gt; selectors = emptyList(String.class);</span>
<span class="fc" id="L46">    public List&lt;String&gt; selectors() { return selectors; }</span>
<span class="fc" id="L47">    public boolean noSelectors() { return selectors().isEmpty(); }</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">    public boolean hasSelectors() { return !selectors().isEmpty(); }</span>
<span class="nc" id="L49">    public void clearSelectors() { this.selectors.clear(); }</span>
<span class="fc" id="L50">    public int countSelectors() { return selectors().size(); }</span>
<span class="fc" id="L51">    public String firstSelector() { return selectors().get(0); }</span>
<span class="fc" id="L52">    public String finalSelector() { return selectors().get(countSelectors() - 1); }</span>
<span class="fc" id="L53">    @Override public boolean throwsException() { return endsWith(Keyword.Throw); }</span>
<span class="pc bpc" id="L54" title="1 of 4 branches missed.">    public boolean startsWith(String selector) { return hasSelectors() &amp;&amp; firstSelector().equals(selector); }</span>
<span class="fc bfc" id="L55" title="All 4 branches covered.">    public boolean endsWith(String selector) { return hasSelectors() &amp;&amp; finalSelector().equals(selector); }</span>

    static final String PredicateMessage = &quot;toPredicate&quot;;
<span class="fc" id="L58">    @Override public boolean producesPredicate() { return endsWith(PredicateMessage); }</span>

    public boolean primaryEndsWith(String selector) {
<span class="nc bnc" id="L61" title="All 6 branches missed.">        return hasPrimary() &amp;&amp; primary().isExpression() &amp;&amp; primary().expression().primaryTerm().endsWith(selector); }</span>

<span class="pc bpc" id="L63" title="1 of 4 branches missed.">    public boolean isLoopy() { return countSelectors() == 1 &amp;&amp; LoopMap.containsKey(firstSelector()); }</span>
    public String removeOnlySelector() {
<span class="nc" id="L65">        String result = firstSelector();</span>
<span class="nc" id="L66">        clearSelectors();</span>
<span class="nc" id="L67">        return result;</span>
    }

<span class="fc" id="L70">    Primary primary = null;</span>
<span class="fc" id="L71">    public Primary primary() { return primary; }</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">    protected void cleanPrimary() { if (hasPrimary()) this.primary.clean(); }</span>
<span class="fc" id="L73">    public boolean noPrimary() { return hasNo(primary()); }</span>
<span class="fc" id="L74">    public boolean hasPrimary() { return hasAny(primary()); }</span>
<span class="pc bpc" id="L75" title="1 of 4 branches missed.">    @Override public boolean containsExit() { return hasPrimary() &amp;&amp; primary().exitsMethod(); }</span>
<span class="pc bpc" id="L76" title="3 of 6 branches missed.">    @Override public boolean hasOnlyValue() { return hasPrimary() &amp;&amp; primary().hasOnlyValue() &amp;&amp; noSelectors(); }</span>
<span class="pc bpc" id="L77" title="1 of 4 branches missed.">    @Override public boolean selfIsPrimary() { return hasPrimary() &amp;&amp; primary().selfIsPrimary(); }</span>
<span class="nc bnc" id="L78" title="All 4 branches missed.">    public boolean superIsPrimary() { return hasPrimary() &amp;&amp; primary().isSuper(); }</span>
<span class="fc" id="L79">    public Block primaryBlock() { return primary().block(); }</span>
    public UnarySequence withPrimary(Primary primary) {
<span class="fc" id="L81">        this.primary = primary;</span>
<span class="fc" id="L82">        this.contain(primary);</span>
<span class="fc" id="L83">        return this;</span>
    }

    @Override public TypeName typeResolver() {
<span class="nc bnc" id="L87" title="All 2 branches missed.">        return noPrimary() ? super.typeResolver() : primary().typeResolver(); }</span>

<span class="nc bnc" id="L89" title="All 6 branches missed.">    @Override public boolean isConstructed() { return noSelectors() &amp;&amp; (selfIsPrimary() || superIsPrimary()); }</span>
<span class="fc" id="L90">    public boolean containsOnlyClass() { return containsOnly(Keyword.ClassMessage); }</span>
<span class="nc" id="L91">    public boolean containsOnlyYourself() { return containsOnly(Keyword.Yourself); }</span>
    public boolean containsOnly(String selector) {
<span class="fc bfc" id="L93" title="All 4 branches covered.">        return (countSelectors() == 1) &amp;&amp; firstSelector().equals(selector); }</span>

    public Emission emitPrimaryTerm() {
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (noPrimary()) return emitEmpty();</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">        return this.hasPrimitiveContext() ? primary().emitPrimitive() : primary().emitOperand(); }</span>

<span class="fc" id="L99">    @Override public List&lt;Emission&gt; emitArguments() { return EmptyList; }</span>
<span class="fc" id="L100">    @Override public Emission emitExpression() { return emitExpression(emitPrimaryTerm(), emitMessages()); }</span>
<span class="fc" id="L101">    public List&lt;Emission&gt; emitMessages() {  return map(selectors(), s -&gt; emitCall(s)); }</span>

<span class="fc" id="L103">    private Emission emitNewPrimary() { return emitNew(emitPrimaryTerm(), EmptyList); }</span>
    private Emission emitTypeNewPrimary() {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (selfIsPrimary()) return emitExpression();</span>
<span class="nc" id="L106">        return emitTypeNew(emitPrimaryTerm(), EmptyList); }</span>

    @Override public Emission emitPrimitive() {
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (throwsException()) return emitThrow();</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (containsOnlyClass()) return emitClassAccess();</span>

<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (endsWith(Keyword.BasicNew)) return emitNewPrimary();</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">        if (endsWith(Keyword.NewMessage)) return emitTypeNewPrimary();</span>
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        if (endsWith(Keyword.ArrayNew)) return emitNewArray(emitPrimaryTerm());</span>

<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (startsWith(Keyword.BasicNew)) return emitNewExpression();</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (startsWith(Keyword.NewMessage)) return emitTypeNewExpression();</span>

<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        return emitExpression(noPrimary() ? emitEmpty() : primary().emitPrimitive(), emitMessages());</span>
    }

    @Override public Emission emitOperand() {
<span class="fc bfc" id="L123" title="All 2 branches covered.">        if (this.hasPrimitiveContext()) {</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">            if (this.containsOnlyClass()) {</span>
<span class="nc" id="L125">                return emitClassAccess();</span>
            }
        }

<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        if (throwsException()) return emitThrow();</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">        if (endsWith(Keyword.BasicNew)) return emitNewPrimary();</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (endsWith(Keyword.NewMessage)) return emitTypeNewPrimary();</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (endsWith(Keyword.ArrayNew)) return emitNewArray(emitPrimaryTerm());</span>

<span class="pc bpc" id="L134" title="1 of 2 branches missed.">        if (startsWith(Keyword.BasicNew)) return emitNewExpression();</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        if (startsWith(Keyword.NewMessage)) return emitTypeNewExpression();</span>

<span class="fc" id="L137">        return emitExpression();</span>
    }

    private Emission emitClassAccess() {
<span class="fc" id="L141">        return emitExpression(emitPrimaryTerm(), emitPath(Keyword.ClassSelector)); }</span>

    private Emission emitNewExpression() {
<span class="nc" id="L144">        List&lt;Emission&gt; messages = emitMessages();</span>
<span class="nc" id="L145">        messages.remove(0); // remove 1st message</span>
<span class="nc" id="L146">        return emitExpression(emitNewPrimary(), messages);</span>
    }

    private Emission emitTypeNewExpression() {
<span class="nc" id="L150">        List&lt;Emission&gt; messages = emitMessages();</span>
<span class="nc" id="L151">        messages.remove(0); // remove 1st message</span>
<span class="nc" id="L152">        return emitExpression(emitTypeNewPrimary(), messages);</span>
    }

<span class="pc bpc" id="L155" title="1 of 2 branches missed.">    private Emission emitThrow() { return selfIsPrimary() ? emitThrowSelf() : emitThrowItem(); }</span>
    public Emission emitThrowItem() {
<span class="fc" id="L157">        List&lt;Emission&gt; messages = emitMessages();</span>
<span class="fc" id="L158">        messages.remove(messages.size() - 1);</span>
<span class="fc" id="L159">        return emitThrow(emitExpression(emitPrimaryTerm(), messages)); }</span>

} // UnarySequence
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>