<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TokenCompiler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hoot-compiler</a> &gt; <a href="index.source.html" class="el_package">Hoot.Compiler.Scopes</a> &gt; <span class="el_source">TokenCompiler.java</span></div><h1>TokenCompiler.java</h1><pre class="source lang-java linenums">package Hoot.Compiler.Scopes;

import java.io.*;
import org.antlr.v4.runtime.*;
import org.antlr.v4.runtime.tree.*;

import Hoot.Compiler.*;
import static Hoot.Compiler.HootParser.*;
import static Hoot.Compiler.Notes.Comment.*;
import static Hoot.Runtime.Functions.Exceptional.*;
import org.stringtemplate.v4.AutoIndentWriter;
import Hoot.Runtime.Faces.Logging;

/**
 * Compiles a Hoot file from a token stream with a parser.
 *
 * @author nik &lt;nikboyd@sonic.net&gt;
 * @see &quot;Copyright 2010,2021 Nikolas S Boyd.&quot;
 * @see &quot;Permission is granted to copy this work provided this copyright statement is retained in all copies.&quot;
 */
public class TokenCompiler implements Logging {

    File tokenFile;
<span class="fc" id="L24">    public TokenCompiler(File aFile) { tokenFile = aFile; }</span>
<span class="fc" id="L25">    private String tokenFilepath() { return tokenFile.sourceFile().getAbsolutePath(); }</span>
<span class="fc" id="L26">    private CharStream createInputStream() throws Exception { return new ANTLRFileStream(tokenFilepath()); }</span>
<span class="fc" id="L27">    private HootParser createParser() throws Exception { return new HootParser(createTokenStream()); }</span>
<span class="fc" id="L28">    private TokenSource createLexer() throws Exception { return new HootLexer(createInputStream()); }</span>
<span class="fc" id="L29">    private void popScope() { tokenFile.popScope(); }</span>

    CommonTokenStream tokenStream;
<span class="fc" id="L32">    public CommonTokenStream tokenStream() { return tokenStream; }</span>
<span class="fc" id="L33">    private CommonTokenStream tokenStream(CommonTokenStream stream) { this.tokenStream = stream; return tokenStream; }</span>
<span class="fc" id="L34">    private TokenStream createTokenStream() throws Exception { return tokenStream(new CommonTokenStream(createLexer())); }</span>

    public boolean compile() {
<span class="fc" id="L37">        java.io.File sourceFile = tokenFile.sourceFile();</span>
<span class="pc bpc" id="L38" title="2 of 4 branches missed.">        if (sourceFile == null || !sourceFile.exists()) {</span>
<span class="nc" id="L39">            reportMissingSource();</span>
<span class="nc" id="L40">            return false;</span>
        }

<span class="fc" id="L43">        parseTokens();</span>
<span class="pc bpc" id="L44" title="1 of 2 branches missed.">        if (wasParsed()) {</span>
<span class="fc" id="L45">            emitCode();</span>
<span class="fc" id="L46">            return true;</span>
        }
        else {
<span class="nc" id="L49">            return false;</span>
        }
    }

    HootParser parser;
<span class="fc bfc" id="L54" title="All 2 branches covered.">    public boolean wasParsed() { return parser != null; }</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">    public boolean notParsed() { return parser == null; }</span>

    CompilationUnitContext resultUnit;
    private void parseUnit() throws Exception {
<span class="fc" id="L59">        tokenFile.makeCurrent();</span>
<span class="fc" id="L60">        report(&quot;parsing &quot; + tokenFile.name());</span>

<span class="fc" id="L62">        parser = createParser();</span>
<span class="fc" id="L63">        resultUnit = parser.compilationUnit();</span>
<span class="fc" id="L64">        tokenFile.cacheComments(buildComments(tokenStream()));</span>
<span class="fc" id="L65">        ParseTreeWalker walker = new ParseTreeWalker();</span>
<span class="fc" id="L66">        walker.walk(new HootBaseListener(), resultUnit);</span>
<span class="fc" id="L67">    }</span>

<span class="fc bfc" id="L69" title="All 2 branches covered.">    public void parseTokens() { if (wasParsed()) return;</span>
<span class="fc" id="L70">        runLoudly(() -&gt; { parseUnit(); }, () -&gt; { popScope(); }); }</span>

    private void emitCode() {
<span class="fc" id="L73">        tokenFile.clean();</span>
<span class="fc" id="L74">        java.io.File targetFolder = tokenFile.facePackage().createTarget();</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">        if (targetFolder == null) return; // failure already reported</span>

<span class="fc" id="L77">        report(&quot;writing &quot; + tokenFile.targetFilename());</span>
<span class="fc" id="L78">        emitCodeIn(new java.io.File(targetFolder, tokenFile.targetFilename()));</span>
<span class="fc" id="L79">    }</span>

    private void emitCodeIn(java.io.File targetFile) {
<span class="fc" id="L82">        try (PrintWriter writer = new PrintWriter(new FileWriter(targetFile))) {</span>
<span class="fc" id="L83">            tokenFile.emitScope().result().write(new AutoIndentWriter(writer));</span>
        }
<span class="nc" id="L85">        catch (Exception ex) {</span>
<span class="nc" id="L86">            error(ex.getMessage(), ex);</span>
<span class="fc" id="L87">        }</span>
<span class="fc" id="L88">    }</span>

    private void reportMissingSource() {
<span class="nc" id="L91">        String message = &quot;can't find source file for &quot; + tokenFile.faceName();</span>
<span class="nc" id="L92">        error(message);</span>
<span class="nc" id="L93">    }</span>

} //  TokenCompiler
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>